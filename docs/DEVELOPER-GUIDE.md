# Developer Guide

Welcome to the Job Hunt Dashboard codebase. This guide will help you understand the architecture, make changes, and maintain the system.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [File Organization](#file-organization)
3. [Data Flow](#data-flow)
4. [Making Changes](#making-changes)
5. [Common Tasks](#common-tasks)
6. [Troubleshooting](#troubleshooting)
7. [Testing](#testing)

---

## Architecture Overview

### The 5-Phase Job Search Workflow

```
Phase 1: FETCH      ‚Üí Phase 2: FILTER ‚Üí Phase 3: RESEARCH ‚Üí Phase 4: MERGE ‚Üí Phase 5: SYNC
[API Scripts]         [Script]          [AI Agents]          [Script]        [Script]
Sequential            O(1) lookups      Parallel Haiku       JSON merge      Database upsert
0 tokens              0 tokens          ~2-4k tokens         0 tokens        0 tokens
```

**Design Philosophy:** Use AI only where judgment is needed. Everything else is scripts.

### Why This Architecture?

#### Original Problem (v1.0)
- Sonnet agents handled filtering and merging ‚Üí 10-20k tokens per search
- Web scraping fragile (HTML changes broke scrapers)
- Incomplete data from email summaries (no full descriptions)

#### Solution (v1.1)
- **Phase 1 (Fetch):** API calls instead of scraping (reliable, complete data)
- **Phase 2 (Filter):** Simple database lookups (no AI needed)
- **Phase 3 (Research):** AI agents (requires judgment - red flags, URL verification)
- **Phase 4 (Merge):** JSON field copying (deterministic)
- **Phase 5 (Sync):** Database operations (deterministic)

**Result:** 80% token reduction, faster execution, more reliable data.

---

## File Organization

### Scripts Directory (`scripts/`)

All scripts follow this structure:

```javascript
/**
 * Multi-line JSDoc header
 * - Purpose
 * - Workflow position
 * - Inputs/outputs
 * - Usage examples
 * - Maintenance notes
 */

// === CONFIGURATION ===
// Constants, environment variables, settings

// === HELPER FUNCTIONS ===
// Pure functions with JSDoc comments

// === MAIN EXECUTION ===
async function main() {
  // Step-by-step workflow with console.log progress
}

main().catch(error => {
  console.error('‚ùå Fatal error:', error);
  process.exit(1);
});
```

**Key Scripts:**

| Script | Purpose | Tokens Used |
|--------|---------|-------------|
| `fetch-adzuna.js` | Fetch from Adzuna API | 0 |
| `fetch-reed.js` | Fetch from Reed API | 0 |
| `filter-new.js` | Filter new jobs vs database | 0 |
| `merge-research.js` | Merge research results | 0 |
| `sync-jobs.js` | Sync to database | 0 |
| `auto-ghost.js` | Mark stale applications | 0 |
| `update-research.js` | Update single job research | 0 |

### Candidate Files (`candidates/`)

JSON files containing job data at various stages:

| File | Generated By | Purpose |
|------|--------------|---------|
| `adzuna.json` | `fetch-adzuna.js` | Jobs from Adzuna API |
| `reed.json` | `fetch-reed.js` | Jobs from Reed API |
| `research-queue.json` | `filter-new.js` | Jobs needing AI research |
| `research-results.json` | AI agents (manual) | Research findings |

**Important:** These files are the "source of truth" before database sync. Preserve them for debugging.

### Documentation (`docs/`)

| File | Purpose |
|------|---------|
| `DEVELOPER-GUIDE.md` | This file - comprehensive developer documentation |
| `TODO-SUMMARY.md` | All documented TODOs and future improvements |

---

## Data Flow

### Complete Job Search Flow

```
1. API FETCH
   ‚îú‚îÄ npm run fetch:adzuna
   ‚îÇ  ‚îî‚îÄ Output: candidates/adzuna.json
   ‚îî‚îÄ npm run fetch:reed
      ‚îî‚îÄ Output: candidates/reed.json

2. FILTER NEW
   ‚îú‚îÄ npm run filter:new
   ‚îÇ  ‚îú‚îÄ Reads: candidates/*.json
   ‚îÇ  ‚îú‚îÄ Checks: Supabase jobs table
   ‚îÇ  ‚îî‚îÄ Output: candidates/research-queue.json
   ‚îî‚îÄ Console: Summary of new vs existing jobs

3. RESEARCH (AI - MANUAL STEP)
   ‚îú‚îÄ Read: candidates/research-queue.json
   ‚îú‚îÄ Launch: Parallel Haiku agents (via Claude Code)
   ‚îÇ  ‚îú‚îÄ WebSearch for company info
   ‚îÇ  ‚îú‚îÄ WebFetch to verify URLs
   ‚îÇ  ‚îî‚îÄ Analyze for red flags
   ‚îî‚îÄ Save: candidates/research-results.json (manually)

4. MERGE RESEARCH
   ‚îú‚îÄ npm run merge:research -- --results=research-results.json
   ‚îÇ  ‚îú‚îÄ Reads: research-results.json
   ‚îÇ  ‚îú‚îÄ Updates: candidates/*.json (adds directJobUrl, redFlags, etc)
   ‚îÇ  ‚îî‚îÄ Filters: expired jobs
   ‚îî‚îÄ Console: Summary of merged data

5. SYNC TO DATABASE
   ‚îú‚îÄ npm run sync
   ‚îÇ  ‚îú‚îÄ Reads: candidates/*.json
   ‚îÇ  ‚îú‚îÄ Filters: expired jobs, duplicates
   ‚îÇ  ‚îî‚îÄ Inserts: new jobs to Supabase
   ‚îî‚îÄ Console: Top opportunities
```

### Job Object Schema Evolution

#### After Phase 1 (Fetch)
```json
{
  "id": "adzuna-acme-corp-ux-designer",
  "title": "UX Designer",
  "company": "Acme Corp",
  "location": "Manchester",
  "source": "adzuna",
  "type": "direct",
  "url": "https://adzuna.com/...",
  "remote": false,
  "salary": "50k-65k",
  "seniority": "mid",
  "roleType": "ux",
  "freshness": "fresh",
  "description": "...",
  "suitability": 18,
  "postedAt": "2026-01-15T00:00:00Z"
}
```

#### After Phase 3 (Research)
Research results saved separately:
```json
{
  "id": "adzuna-acme-corp-ux-designer",
  "company": "Acme Corp",
  "is_recruiter": false,
  "direct_job_url": "https://acme.com/careers/123",
  "expired": false,
  "red_flags": [
    {
      "type": "glassdoor_low",
      "severity": "medium",
      "summary": "3.2 rating on Glassdoor (45 reviews)",
      "source": "https://glassdoor.com/..."
    }
  ]
}
```

#### After Phase 4 (Merge)
Research fields merged into candidate:
```json
{
  // ... all original fields ...
  "directJobUrl": "https://acme.com/careers/123",
  "expired": false,
  "redFlags": [...],
  "type": "direct"  // or "recruiter" if is_recruiter: true
}
```

#### After Phase 5 (Sync - Database)
Transformed to database schema:
```sql
{
  id: "adzuna-acme-corp-ux-designer",
  title: "UX Designer",
  company: "Acme Corp",
  location: "Manchester",
  url: "https://adzuna.com/...",
  salary: "50k-65k",
  remote: false,
  seniority: "mid",
  role_type: "ux",
  application_type: "direct",
  freshness: "fresh",
  description: "...",
  source: "adzuna",
  status: "new",
  suitability: 18,
  posted_at: "2026-01-15T00:00:00Z",
  career_page_url: "https://acme.com/careers/123",
  red_flags: [...],
  research_status: "complete",
  researched_at: "2026-01-18T12:00:00Z"
}
```

---

## Making Changes

### Adding a New Job Source

Example: Adding Indeed API

1. **Create fetch script** (`scripts/fetch-indeed.js`)
   ```javascript
   // Copy structure from fetch-adzuna.js
   // Update API endpoints, auth, search queries
   // Ensure same output schema (id, title, company, etc)
   ```

2. **Update package.json**
   ```json
   "fetch:indeed": "node scripts/fetch-indeed.js",
   "fetch:all": "npm run fetch:adzuna && npm run fetch:reed && npm run fetch:indeed"
   ```

3. **Update SOURCES arrays**
   - `scripts/filter-new.js` - line 33
   - `scripts/sync-jobs.js` - line 31

4. **Test the integration**
   ```bash
   npm run fetch:indeed
   # Check candidates/indeed.json
   npm run filter:new
   # Verify new source included
   ```

5. **Update documentation**
   - `agents/CLAUDE.md` - Step 1
   - `README.md` - Features and NPM Scripts
   - `CHANGELOG.md` - New entry

### Modifying Scoring Logic

Scoring happens in **fetch scripts** (Phase 1), not research phase.

**Example:** Add bonus points for "accessibility" keyword

1. **Update fetch-adzuna.js** (line ~146)
   ```javascript
   // In calculateScore function
   if (desc.includes('accessibility')) score += 3;
   ```

2. **Update fetch-reed.js** (same change)

3. **Update agents/CLAUDE.md** - Scoring table

4. **Test with real data**
   ```bash
   npm run fetch:all
   # Check suitability scores in candidates/*.json
   ```

### Changing Research Threshold

The threshold determines which jobs get AI research (default: 15).

1. **Update scripts/filter-new.js**
   ```javascript
   const RESEARCH_THRESHOLD = 20; // Was 15
   ```

2. **Update agents/CLAUDE.md**
   - Architecture section
   - Step 2 description

3. **Impact:**
   - Higher threshold = fewer jobs researched = lower token usage
   - Lower threshold = more jobs researched = better data quality

### Modifying Database Schema

If you change the jobs table schema:

1. **Create migration SQL**
   ```sql
   -- Add new column
   ALTER TABLE jobs ADD COLUMN new_field TEXT;
   ```

2. **Update scripts/sync-jobs.js**
   - `toDbRow()` function (line ~77)
   - Add mapping for new field

3. **Update TypeScript types**
   - `src/types/job.ts`

4. **Update React components** as needed

5. **Run migration** in Supabase SQL Editor

---

## Common Tasks

### Running a Full Job Search

```bash
# 1. Fetch from APIs
npm run fetch:all

# 2. Filter new jobs
npm run filter:new

# 3. Research companies (AI - do manually via Claude Code)
#    - Read candidates/research-queue.json
#    - Launch parallel Haiku agents
#    - Save results to candidates/research-results.json

# 4. Merge research results
npm run merge:research

# 5. Sync to database
npm run sync
```

### Debugging a Failed Sync

```bash
# Check what would be synced
npm run filter:new
# Review research-queue.json

# Test sync in isolation
npm run sync
# Check console output for errors

# Inspect failed jobs
# sync-jobs.js writes to candidates/failed-import.json on error
cat candidates/failed-import.json
```

### Updating Research for Single Job

```bash
# Use the dedicated script
npm run update-research

# Follow prompts to:
# 1. Enter job ID
# 2. Provide new research data
# 3. Script updates both candidates file and database
```

### Resetting Database (DANGER)

```bash
npm run reset
# Deletes ALL jobs from database
# Use only in development
```

---

## Troubleshooting

### "No new jobs found" but I know there are new jobs

**Cause:** Deduplication is matching jobs as existing.

**Debug:**
1. Check ID generation: `scripts/filter-new.js` line ~34
2. Check company+title normalization
3. Query database directly:
   ```sql
   SELECT id, company, title FROM jobs WHERE company LIKE '%YourCompany%';
   ```

### API fetch returns 0 jobs

**Adzuna:**
- Check API credentials in `.env.local`
- Verify API quota: https://developer.adzuna.com/
- Check search queries (line ~29)

**Reed:**
- Check API key (Basic Auth)
- Rate limit: 1000 calls/day
- Verify locationName is valid

### Research results not merging

**Cause:** ID mismatch between research and candidates.

**Debug:**
1. Check research-results.json has correct IDs
2. Verify IDs match candidates/*.json
3. Run with verbose logging:
   ```javascript
   // In merge-research.js, add console.log
   console.log('Looking for ID:', job.id);
   console.log('Research IDs:', Array.from(researchMap.keys()));
   ```

### Duplicate jobs in database

**Cause:** ID generation changed or deduplication failed.

**Fix:**
1. Identify duplicates:
   ```sql
   SELECT company, title, COUNT(*)
   FROM jobs
   GROUP BY company, title
   HAVING COUNT(*) > 1;
   ```

2. Delete duplicates (keep highest suitability):
   ```sql
   -- Careful! Test query first
   DELETE FROM jobs
   WHERE id IN (
     SELECT id FROM jobs
     WHERE company = 'X' AND title = 'Y'
     ORDER BY suitability ASC
     LIMIT 1
   );
   ```

---

## Testing

### Manual Testing Checklist

Before committing changes:

- [ ] Run `npm run fetch:all` - should complete without errors
- [ ] Run `npm run filter:new` - should show correct new job count
- [ ] Check `candidates/research-queue.json` - jobs meet threshold
- [ ] Run `npm run merge:research` - should update candidates
- [ ] Run `npm run sync` - should insert to database
- [ ] Check database - new jobs should appear
- [ ] Run `npm run dev` - dashboard should load
- [ ] Test status changes - buttons should work
- [ ] Check console - no React errors

### Test Data

Create test candidate files:

```javascript
// candidates/test-source.json
[
  {
    "id": "test-acme-ux-designer",
    "title": "UX Designer",
    "company": "Acme Test Corp",
    "location": "Test City",
    "source": "test-source",
    "type": "direct",
    "url": "https://example.com/job",
    "remote": true,
    "salary": "60k-75k",
    "seniority": "mid",
    "roleType": "ux",
    "freshness": "fresh",
    "description": "Test job description",
    "suitability": 20,
    "postedAt": "2026-01-18T00:00:00Z"
  }
]
```

Then test scripts:
```bash
# Add 'test-source' to SOURCES array temporarily
npm run filter:new
npm run sync
```

---

## Best Practices

### Code Style

1. **Commenting**
   - Every function gets JSDoc comment
   - Explain "why" not "what"
   - Add examples for complex logic

2. **Error Handling**
   - Always catch and log errors
   - Provide helpful error messages
   - Exit with code 1 on fatal errors

3. **Console Output**
   - Use emojis sparingly (‚úÖ ‚ùå ‚ÑπÔ∏è üí°)
   - Show progress for long operations
   - Summarize results at end

4. **TODOs**
   - Use categories: [MISSING], [REFACTOR], [TEST]
   - Add context and implementation notes
   - Document in `docs/TODO-SUMMARY.md`

### Performance

1. **Database Queries**
   - Select only needed columns
   - Use indexes (status, suitability, applied_at)
   - Batch operations when possible

2. **API Calls**
   - Respect rate limits
   - Add delays between requests (Reed: 100ms)
   - Cache results when appropriate

3. **Token Usage**
   - Only use AI for judgment tasks
   - Use Haiku over Sonnet when possible
   - Never use Opus (too expensive)

---

## Additional Resources

- **Supabase Docs:** https://supabase.com/docs
- **Adzuna API:** https://developer.adzuna.com/
- **Reed API:** https://www.reed.co.uk/developers
- **Claude Code Docs:** https://github.com/anthropics/claude-code

---

**Questions?** Check `agents/CLAUDE.md` for AI-specific workflow details or `docs/TODO-SUMMARY.md` for known limitations.

**Last Updated:** 2026-01-18 (v1.1.0)
